---
title: "Что делает браузер до отрисовки страницы?"
tags: ["Frontend", "Browser"]
date: "2021-02-12"
active: "true"
ready: "true"
---


JavaScript код всегда выполняется в некотором окружении, среде исполнения.
Чаще всего мы используем JavaScript в среде исполнения браузера. Но это также могут быть и IoT
устройства и NodeJS.

Понимание, как работает окружение, поможет в оптимизации работы программ.

Разбираемся, какие этапы проходит браузер до отрисовки страницы, и что делать,
чтобы этот процесс происходил максимально быстро.

### Компоненты браузера

- User interface
- Browser engine
- Rendering engine
- Networking
- JavaScript engine
- UI Backend
- Data Persistence

### User interface (Пользовательский интерфейс)

Это элементы, которые присутствуют в браузере за пределами основного документа сайта.
Это кнопки навигации, закладки, расширения и тд.

### Browser engine (Движок браузера)

Занимается взаимодействием между UI браузера и слоем рендеринга.

### Rendering engine (Движок рендеринга)

Отвечается за отрисовку контента, который пришел по сети.
По сути этот слой парсит HTML и CSS и отображает контент на странице.

### Networking (Сетевой слой)

Этот слой предоставляет платформенно-независимые интерфейс для работы по сети.
Сюда относиться XHR-запросы, которые мы обычно делаем для отправки запросов и получения данных
по протоколу HTTP.

### UI Backend (Базовый прикладной интерфейс)

Этот слой предоставляет базовые прикладные элементы
такие как чекбоксы, поля ввода, формы, не зависящие от платформы.

### Javascript engine

Отвечает за парсинг и исполнение JavaScript кода.

### Data storage (Слой хранения данных)

Предоставляет возможность хранить данные на стороне клиента.
Сюда относятся cookie, localStorage, indexDB, WebSQL, FileSystem.


## Процесс рендеринга страницы (Rendering engine)

Движок рендеринга отвечает за отображение документа на странице любого формата.
Это умеет делать любой из существующих движков:

- Gecko - Firefox
- Webkit - Safari
- Blink - Chrome

После того, как слой рендеринга получил содержимое документа происходит процесс отрисовки в несколько этапов:

- Парсинг HTML в объектную модуль документа DOM
- Создание дерева рендеринга
- Просчитывается положение элементов на странице, формируется макет страницы, структура
- Визуализация дерева, применение стилей

 
## Парсинг HTML, создание DOM и CSSOM

Создание DOM происходит инкрементально. DOM представляет из себя древовидную структуру узов элементов HTML.
Чем больше узлов имеет приложение, тем дольше происходит формирование DOM tree.

При этом каждый раз, когда браузер встречает на своем пути тег ```<script>```,
он останавливает процесс парсинга и ждет загрузки и исполнения скрипта. 

Создание CSSOM Блокирует рендеринг до тех пор, пока не получит и не обработает все CSS-правила.
Так как правила могут быть перезаписаны, поэтому браузер ждет построения CSSOM.

CSSOM строится по мере парсинга css. И может использовать в построении render tree только после полного построения.
Иначе может оказаться так, что следующий набор правил сделает элемент невидимым и приведет к дополнительному
вызову компоновки и перерасчета стилей.

Браузер начинает с обхода более общих правил. Например, если элемент является потомком body, то к нему
применятся все стили описанные для body. Затем рекурсивно применят более специфичные стили.

Более специфичные правила требуют обхода большего количества узлов в DOM.

```css
/*Сработает быстрее*/
.item {}

/*Сработает медленнее*/
.container .item {}
```

Но специфичность селекторов не то, что необходимо оптимизировать. Ваша производительность возрастет на микросекунды.

Об оптимизации мы поговорим ниже.

## Создание дерева рендеринга

Объединяет CSSOM и DOM в единое дерево.

Проверяет каждый узел DOM, начиная с корневого элемента и определяет какие CSS правила к нему нужно присоединить.

Оно охватывает только видимые элементы, все, что влияет на внешний вид страницы.
Например он не включает в свое дерево элементы со свойством display: none или содержимое тега ```<head>```.

## Компоновка (Layout)

На этом этапе определяется как будут отображаться элементы на странице и как они друг с другом связаны.
Происходит рекурсивный проход начиная от корневого элемента html с позиции (0, 0) видимой области
и задается точное позиционирование каждого элемента, его координаты left и top.

Все это происходит внутри основного окна viewport (видимая область), которую мы можем задавать внутри элемента head
в теге meta. Значение viewport влияет на скорость компоновки элементов.

При изменении размеров окна браузера или, если пользователь повернул телефон, заново происходит этап компоновки.

На производительность компоновки влияет DOM, а точнее количество узлов в нем.
Каждый раз при внесении изменений в объектную модель документа или
внесение изменений в стили box-модели, влияющих на размеры или положение элементов, также вызывается процесс компоновки.


## Отрисовка (Painting)

Последний этап - отрисовка пикселей на экране. Происходит обход дерева рендеринга и вызов метода paint() его объектов.

Каждое css свойство узла увеличивает время отрисовки. Но оптимизация количества свойств даст лишь небольшой прирост в производительности.
Поэтому не стоит им злоупотреблять. Если у вас проблемы со скоростью отрисовки, вряд ли это связано с количеством свойств стилей элементов.

## Советы по оптимизации

- Минификация css и js файлов. Также можно включать дополнительное сжатие ресурсов на стороне сервера
- Разделение CSS на файлы и подключение по мере необходимости
- Подключайте JS скрипты в конце файла. И откладывайте загрузку критических ресурсов, добавляя атрибуты async и defer
- Используйте веб воркеры для длительных и сложных вычислений. Но не забывайте, что в веб воркерах нельзя проводить манипуляции с DOM
- Помните, что любое изменение свойств css, связанных с шириной, высотой или расположением требуют изменения макета и перерисовки. Используйте с умом
